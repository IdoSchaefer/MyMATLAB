psi0 = [1;0;0];
target = [0;1;0];
ftarget = phi2ftarget(target);
H0 = diag([0, 1, 1.96]);
Edomain = [-1, 3];
mu = [0 1 0; 1 0 sqrt(2); 0 sqrt(2) 0];
[Hoperations, fmu] = Hmats2Hops(H0, mu);
allT = (4:10)*2*pi*5;
NT = length(allT);
Nt_ts = 7;
Ncheb = 7;
Nt_max = 1000;
dt = allT(end)/Nt_max;
options = optionsOCqn(1e-4, 1e4);
fieldws = zeros(NT, Nt_max + 1);
fieldts = zeros(NT, Nt_max*(Nt_ts - 1) + 1);
allpsi = zeros(3, Nt_max + 1, length(allT));
allconv = zeros(NT, 10001);
allniter = zeros(1, NT);
allJmax = zeros(1, NT);
energies = zeros(1, NT);
allrelE = zeros(1, NT);
for Ti = 1:NT
    options.f_max_alpha =  get_f_max_alphaOCf(0.5, dt, allT(Ti), 1e3*0.5*(1 - tanh(2*(w-3))));
    Nti = round(Nt_max*allT(Ti)/allT(end));
    %[fieldt3u3I, fieldw3u3I, psi3u3I, relE3u3I, conv3u3I, niter3u3I, mallniterc3u3I, Jterms3u3I, maxgrad3u3I, alpha3u3I, invHess3u3I] = OClimf_qn(u0_3, ftarget3u3I, Hoperations3u1ceI, 2, fcouplingOp3u1ce, [-0.2 0.2], fieldw3u3, @(w)5*0.5*(1-tanh(20*(w-0.25))), options3u3I, 400, 0.25, 7, 7, 1e-6);
    [fieldts(Ti, 1:(Nti + 1)), fieldws(Ti, 1:(Nti + 1)), allpsi(:, 1:(Nti + 1), Ti), allrelE(Ti), convi, allniter(Ti), ~, Jtermsi] = OClimf_qn(psi0, ftarget, Hoperations, 1, fmu, Edomain, @(w) 0.01*0.5*(1 - tanh(2*(w-3))), 1e3*0.5*(1 - tanh(2*(w-3))), options, allT(Ti), dt, 7, 7, 1e-6);
    allconv(Ti, 1:(allniter(Ti) + 1)) = convi;
    allJmax(Ti) = Jtermsi.Jmax;
    energies(Ti) = Jtermsi.Jenergy;
end